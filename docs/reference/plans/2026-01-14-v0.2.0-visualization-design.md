# ScpTensor v0.2.0 Visualization Module Design

**Version:** v0.2.0
**Date:** 2026-01-14
**Status:** Design Approved
**Author:** ScpTensor Team

---

## Executive Summary

This document outlines the design for ScpTensor v0.2.0's enhanced visualization module. The goal is to provide a comprehensive set of plotting functions similar to Scanpy, optimized for single-cell proteomics data with SciencePlots styling and multi-panel layouts.

**Key Objectives:**
- Provide Scanpy-style plotting functions with consistent API
- Integrate SciencePlots for publication-quality figures
- Implement native multi-panel layouts
- Handle missing values (MBR/LOD) distinctively from zero values
- Pure Matplotlib backend (no interactive dependencies)

---

## Architecture

### Module Structure

```
scptensor/viz/
├── base/                    # Low-level plotting primitives
│   ├── style.py            # Style configuration (SciencePlots integration)
│   ├── scatter.py          # Scatter plots (existing)
│   ├── heatmap.py          # Heatmaps (existing)
│   ├── violin.py           # Violin plots (existing)
│   ├── multi_panel.py      # Multi-panel layout manager (NEW)
│   ├── data_extractor.py   # Data extraction helper (NEW)
│   ├── missing_value.py    # Missing value visualization (NEW)
│   └── validation.py       # Input validation (NEW)
├── recipes/                # High-level analysis plots (Scanpy-style)
│   ├── embedding.py        # umap, tsne, scatter_embedding
│   ├── feature.py          # dotplot, violin, stacked_violin
│   ├── matrix.py           # matrixplot, heatmap, tracksplot
│   ├── differential.py     # rank_genes_groups_*, volcano
│   ├── qc.py               # QC visualization enhancements
│   └── statistics.py       # correlation, dendrogram
└── __init__.py             # Unified export interface
```

### Design Principles

1. **Consistent API**: All functions follow `plot_xxx(data, layer, groupby, ...)` pattern
2. **Layer-aware**: All functions support `layer` parameter for data layer selection
3. **Mask handling**: Automatically distinguish between missing values (MBR) and zeros
4. **SciencePlots default**: All plots use `plt.style.use(["science", "no-latex"])`
5. **Multi-panel native**: Key functions support `panel_layout` parameter for combined plots

---

## Component Design

### 1. Style Manager (`base/style.py`)

```python
class PlotStyle:
    """Unified style management with SciencePlots integration"""

    # Predefined themes
    THEMES = {
        "science": ["science", "no-latex"],
        "science_grid": ["science", "grid", "no-latex"],
        "ieee": ["ieee", "no-latex"],
        "nature": ["nature", "no-latex"],
    }

    # Proteomics color schemes (distinct from RNA-seq)
    CMAP_PROTEOMICS = {
        "expression": "viridis",     # Expression levels
        "missing": "gray_r",         # Missing values
        "logfc": "RdBu_r",           # Log fold change
        "significance": "plasma",    # Statistical significance
        "clusters": "tab20",         # Cluster colors
    }

    @staticmethod
    def apply_style(theme: str = "science", dpi: int = 300):
        """Apply plotting style"""

    @staticmethod
    def get_colormap(purpose: str, custom: str | None = None):
        """Get color scheme for specific purpose"""
```

### 2. Multi-Panel Layout Manager (`base/multi_panel.py`)

```python
class PanelLayout:
    """Multi-panel combined plot layout manager"""

    def __init__(self, figsize: tuple, grid: tuple = None):
        """
        Parameters
        ----------
        figsize : tuple
            Overall figure size
        grid : tuple or None
            (n_rows, n_cols) or auto-compute
        """

    def add_panel(self, position: str | int, plot_func, **kwargs):
        """Add subplot panel"""

    def add_legend(self, position: str = "right"):
        """Shared legend across panels"""

    def add_colorbar(self, position: str = "right"):
        """Shared colorbar across panels"""

    def finalize(self, tight: bool = True):
        """Finalize layout, adjust spacing"""
```

### 3. Data Extractor (`base/data_extractor.py`)

```python
class DataExtractor:
    """Extract plotting data from ScpContainer with unified handling"""

    @staticmethod
    def get_expression_matrix(container, layer, features=None, samples=None):
        """Get expression matrix, handle sparse/dense"""

    @staticmethod
    def get_group_data(container, groupby, color=None):
        """Get grouping information"""

    @staticmethod
    def handle_missing_values(X, M, method="separate"):
        """
        Handle missing values for visualization

        Parameters
        ----------
        method : str
            - 'separate': Show missing values as gray
            - 'transparent': Missing values transparent
            - 'imputed': Use imputed values
        """
```

### 4. Missing Value Handler (`base/missing_value.py`)

```python
class MissingValueHandler:
    """Unified missing value visualization handling"""

    # Missing value type colors
    MISSING_COLORS = {
        1: "#d3d3d3",  # MBR - Light gray
        2: "#add8e6",  # LOD - Light blue
        3: "#ffcccb",  # FILTERED - Light red
    }

    @staticmethod
    def separate_mask(X: np.ndarray, M: np.ndarray) -> tuple:
        """Separate valid and missing values"""

    @staticmethod
    def create_overlay_scatter(
        x: np.ndarray,
        y: np.ndarray,
        M: np.ndarray,
        ax: plt.Axes,
        **scatter_kwargs
    ):
        """Layer scatter plot (valid + missing values)"""
```

---

## Function API Design

### 1. Embedding Visualization (`recipes/embedding.py`)

```python
def scatter(
    container: ScpContainer,
    layer: str,
    basis: str = "umap",          # umap, pca, tsne
    color: str | list[str] | None = None,
    groupby: str | None = None,
    palette: str | list | None = None,
    size: float = 5.0,
    alpha: float = 0.8,
    use_raw: bool = False,
    show_missing_values: bool = True,
    legend_loc: str = "right margin",
    frameon: bool = True,
    title: str | None = None,
    ax: plt.Axes | None = None,
    **kwargs
) -> plt.Axes:
    """Generic scatter plot for any embedding coordinates"""

def umap(*args, **kwargs) -> plt.Axes:
    """UMAP scatter plot (scatter wrapper)"""

def pca(*args, **kwargs) -> plt.Axes:
    """PCA scatter plot"""

def tsne(*args, **kwargs) -> plt.Axes:
    """t-SNE scatter plot"""
```

### 2. Feature Visualization (`recipes/feature.py`)

```python
def dotplot(
    container: ScpContainer,
    layer: str,
    var_names: list[str],
    groupby: str,
    dendrogram: bool = False,
    log: bool = True,
    cmap: str = "viridis",
    dot_size: float = 5.0,
    standard_scale: str = "var",
    show: bool = True,
    ax: plt.Axes | None = None,
    **kwargs
) -> plt.Axes:
    """
    Dot plot: dot size = expression %, color = mean expression
    Multi-panel: Auto-group to show multiple proteins
    """

def violin(
    container: ScpContainer,
    layer: str,
    var_names: list[str],
    groupby: str,
    log: bool = True,
    jitter: float = 0.4,
    scale: str = "width",
    stripplot: bool = True,
    split: bool = False,
    ax: plt.Axes | None = None,
    **kwargs
) -> plt.Axes:
    """Violin plot"""

def stacked_violin(
    container: ScpContainer,
    layer: str,
    var_names: list[str],
    groupby: str,
    dendrogram: bool = False,
    log: bool = True,
    swap_axes: bool = False,
    **kwargs
) -> plt.Axes:
    """Stacked violin plot - multi-panel display"""
```

### 3. Matrix Visualization (`recipes/matrix.py`)

```python
def matrixplot(
    container: ScpContainer,
    layer: str,
    var_names: list[str],
    groupby: str,
    dendrogram: bool = False,
    standard_scale: str = "var",
    cmap: str = "viridis",
    colorbar_title: str = "Mean expression",
    **kwargs
) -> plt.Axes:
    """
    Matrix plot: Group mean expression heatmap
    Multi-panel: Optional dendrogram
    """

def heatmap(
    container: ScpContainer,
    layer: str,
    var_names: list[str],
    groupby: str,
    dendrogram: bool = True,
    log: bool = True,
    cmap: str = "viridis",
    swap_axes: bool = False,
    show: bool = True,
    **kwargs
) -> plt.Axes:
    """
    Heatmap: Each cell as a row
    Multi-panel: Heatmap + dendrogram + legend
    """

def tracksplot(
    container: ScpContainer,
    layer: str,
    var_names: list[str],
    groupby: str,
    dendrogram: bool = False,
    **kwargs
) -> plt.Axes:
    """
    Tracks plot: Expression as height not color
    Multi-panel: Similar to heatmap but more intuitive
    """
```

### 4. Differential Expression Visualization (`recipes/differential.py`)

```python
def rank_genes_groups_dotplot(
    container: ScpContainer,
    layer: str,
    groupby: str,
    n_genes: int = 10,
    values_to_plot: str = "logfoldchanges",
    cmap: str = "RdBu_r",
    dendrogram: bool = False,
    show: bool = True,
    **kwargs
) -> plt.Axes:
    """
    DE ranking Dot plot
    Multi-panel: logFC + significance + expression ratio
    """

def rank_genes_groups_stacked_violin(
    container: ScpContainer,
    layer: str,
    groupby: str,
    n_genes: int = 10,
    cmap: str = "viridis",
    **kwargs
) -> plt.Axes:
    """DE ranking Stacked Violin"""

def rank_genes_groups_matrixplot(
    container: ScpContainer,
    layer: str,
    groupby: str,
    n_genes: int = 10,
    cmap: str = "viridis",
    **kwargs
) -> plt.Axes:
    """DE ranking Matrix plot"""

def volcano(
    container: ScpContainer,
    layer: str,
    groupby: str,
    group1: str,
    group2: str,
    pval_threshold: float = 0.05,
    logfc_threshold: float = 1.0,
    color_up: str = "#d62728",
    color_down: str = "#1f77b4",
    color_ns: str = "#7f7f7f",
    show_labels: int = 10,
    **kwargs
) -> plt.Axes:
    """
    Volcano plot (enhanced)
    Multi-panel: Volcano + top gene list + stats summary
    """
```

### 5. QC Visualization (`recipes/qc.py`)

```python
def pca_overview(
    container: ScpContainer,
    layer: str,
    n_pcs: int = 3,
    color: str | None = None,
    **kwargs
) -> plt.Figure:
    """
    PCA overview - multi-panel combined plot
    Panels:
    - PC1 vs PC2 scatter
    - PC2 vs PC3 scatter
    - Variance ratio bar plot
    - PC loadings heatmap
    """

def pca_variance_ratio(
    container: ScpContainer,
    layer: str,
    n_pcs: int = 50,
    log: bool = False,
    **kwargs
) -> plt.Axes:
    """PCA variance ratio - Scree plot"""

def pca_loadings(
    container: ScpContainer,
    layer: str,
    n_pcs: int = 10,
    features: list[str] | None = None,
    **kwargs
) -> plt.Axes:
    """PC loadings heatmap"""

def missing_value_patterns(
    container: ScpContainer,
    layer: str,
    groupby: str | None = None,
    **kwargs
) -> plt.Figure:
    """
    Missing value pattern analysis - multi-panel
    Panels:
    - Sample missing rate bar plot
    - Protein missing rate bar plot
    - Missing value pattern heatmap
    - Missing value type distribution (MBR/LOD)
    """
```

### 6. Statistical Visualization (`recipes/statistics.py`)

```python
def correlation_matrix(
    container: ScpContainer,
    layer: str,
    groupby: str,
    method: str = "pearson",
    cmap: str = "vlag",
    annot: bool = True,
    **kwargs
) -> plt.Axes:
    """Group correlation matrix heatmap"""

def dendrogram(
    container: ScpContainer,
    layer: str,
    groupby: str,
    method: str = "average",
    metric: str = "euclidean",
    **kwargs
) -> plt.Axes:
    """Hierarchical clustering dendrogram"""
```

---

## Data Flow

```
User calls plot_xxx()
    │
    ├─> DataExtractor.validate_input()
    │       └─> Check layer exists
    │       └─> Check var_names in var
    │       └─> Check groupby in obs
    │
    ├─> DataExtractor.extract()
    │       ├─> X = container[layer].X
    │       ├─> M = container[layer].M
    │       ├─> obs = container.obs
    │       └─> var = container[var].var
    │
    ├─> DataTransformer.transform()
    │       ├─> Sparse → Dense (if needed)
    │       ├─> Log transform (if log=True)
    │       ├─> Standardize (if standard_scale='var')
    │       └─> Aggregate (if groupby)
    │
    ├─> MissingValueHandler.process()
    │       ├─> Separate VALID/MBR/LOD by M
    │       ├─> Generate missing value mask
    │       └─> Set special colors for missing
    │
    ├─> PanelLayout.setup()
    │       ├─> Compute grid (n_rows, n_cols)
    │       ├─> Create Figure and Axes
    │       └─> Set shared axes/legend/colorbar
    │
    ├─> PlotStyle.apply_style()
    │       ├─> plt.style.use(["science", "no-latex"])
    │       ├─> Set DPI=300
    │       └─> Configure proteomics color schemes
    │
    ├─> Plotter.render()
    │       ├─> Call matplotlib functions
    │       ├─> Layer render (bg → data → missing → decor)
    │       └─> Handle multi-panel layout
    │
    └─> return Axes/Figure
```

---

## Error Handling

### Exception Classes

```python
# core/exceptions.py extension
class VisualizationError(ScpTensorError):
    """Base exception for visualization errors"""

class LayerNotFoundError(VisualizationError):
    """Specified layer does not exist"""

class FeatureNotFoundError(VisualizationError):
    """Specified features not in var"""

class GroupNotFoundError(VisualizationError):
    """Specified groupby column not in obs"""

class InvalidPlotParameterError(VisualizationError):
    """Invalid plotting parameter"""

class InsufficientDataError(VisualizationError):
    """Insufficient data for plotting (e.g., all missing)"""
```

### Validation Functions

```python
# base/validation.py
def validate_container(container: ScpContainer) -> None:
    """Validate container"""

def validate_layer(container: ScpContainer, layer: str) -> None:
    """Validate layer exists"""

def validate_features(container: ScpContainer, assay: str, var_names: list[str]) -> None:
    """Validate feature names in var"""

def validate_groupby(container: ScpContainer, groupby: str) -> None:
    """Validate groupby column in obs"""

def validate_plot_data(X: np.ndarray, n_min: int = 1) -> None:
    """Validate sufficient data for plotting"""
```

---

## Implementation Phases

| Phase | Content | Priority |
|-------|---------|----------|
| **Phase 1** | Infrastructure | P0 |
| - style.py extension | Color schemes, theme management | |
| - multi_panel.py | Multi-panel layout manager | |
| - data_extractor.py | Unified data extraction | |
| - missing_value_handler.py | Missing value visualization | |
| | | |
| **Phase 2** | Embedding Visualization | P1 |
| - scatter() | Generic scatter plot | |
| - umap(), pca(), tsne() | Wrapper functions | |
| | | |
| **Phase 3** | Feature Visualization | P1 |
| - dotplot() | Dot plot | |
| - violin() | Violin plot | |
| - stacked_violin() | Stacked violin | |
| | | |
| **Phase 4** | Matrix Visualization | P1 |
| - matrixplot() | Matrix plot | |
| - heatmap() | Heatmap | |
| - tracksplot() | Tracks plot | |
| | | |
| **Phase 5** | Differential Expression | P2 |
| - rank_genes_groups_dotplot() | DE dot plot | |
| - rank_genes_groups_stacked_violin() | DE violin | |
| - volcano() enhancement | Volcano multi-panel | |
| | | |
| **Phase 6** | QC & Statistics | P2 |
| - pca_overview() | PCA overview combined | |
| - missing_value_patterns() | Missing pattern analysis | |
| - correlation_matrix() | Correlation matrix | |
| - dendrogram() | Dendrogram | |

---

## Summary

**v0.2.0 Visualization Module Complete Design:**

| Component | Files | Description |
|-----------|-------|-------------|
| Base Components | 5 files | style, multi_panel, data_extractor, missing_value, validation |
| Embedding | 3 functions | scatter, umap, pca, tsne |
| Feature Viz | 3 functions | dotplot, violin, stacked_violin |
| Matrix Viz | 3 functions | matrixplot, heatmap, tracksplot |
| Differential | 4 functions | rank_genes_groups_*, volcano |
| QC/Stats | 4 functions | pca_overview, missing_patterns, correlation, dendrogram |

**Total: ~17 new functions, 6 infrastructure components**

---

**Document Version:** 1.0
**Last Updated:** 2026-01-14
