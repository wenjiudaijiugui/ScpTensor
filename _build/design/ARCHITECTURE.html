<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html"><link rel="search" title="Search" href="../search.html">

    <!-- Generated with Sphinx 8.2.3 and Furo 2025.12.19 -->
        <title>ScpTensor Architecture Specification - ScpTensor v0.1.0</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">ScpTensor v0.1.0</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <span class="sidebar-brand-text">ScpTensor v0.1.0</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api/index.html">API Reference</a><input aria-label="Toggle navigation of API Reference" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/core.html">Core Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/qc.html">Quality Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/normalization.html">Normalization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/standardization.html">Standardization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/impute.html">Imputation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/integration.html">Batch Correction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/dim_reduction.html">Dimensionality Reduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/feature_selection.html">Feature Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/diff_expr.html">Differential Expression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/cluster.html">Clustering</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/viz.html">Visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/benchmark.html">Benchmark</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/referee.html">Referee (Evaluation)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/utils.html">Utilities</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/yourusername/ScpTensor/edit/main/docs/design/ARCHITECTURE.md" rel="edit" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="scptensor-architecture-specification">
<h1>ScpTensor Architecture Specification<a class="headerlink" href="#scptensor-architecture-specification" title="Link to this heading">¶</a></h1>
<p><strong>Version:</strong> v0.1.0-beta Target
<strong>Document Version:</strong> 1.0
<strong>Last Updated:</strong> 2025-01-05
<strong>Status:</strong> Design Specification</p>
<hr class="docutils" />
<section id="module-responsibility-matrix">
<h2>1. Module Responsibility Matrix<a class="headerlink" href="#module-responsibility-matrix" title="Link to this heading">¶</a></h2>
<section id="overview">
<h3>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h3>
<p>ScpTensor is organized into specialized modules, each with a clear responsibility and well-defined public API. This section documents the architectural design at the module level.</p>
</section>
<hr class="docutils" />
<section id="core-layer-scptensor-core">
<h3>Core Layer (scptensor.core)<a class="headerlink" href="#core-layer-scptensor-core" title="Link to this heading">¶</a></h3>
<p><strong>Responsibility:</strong> Data structures and provenance tracking foundation</p>
<p><strong>Public API:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ScpContainer</span></code> - Global sample management across assays</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Assay</span></code> - Feature-space specific data layer management</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ScpMatrix</span></code> - Physical storage with mask-based provenance tracking</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ProvenanceLog</span></code> - Operation history audit trail</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MaskCode</span></code> - Data status enumeration</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MatrixOps</span></code> - Matrix operation utilities</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reader</span></code> - Data ingestion utilities</p></li>
</ul>
<p><strong>Dependencies:</strong> None (base layer for all other modules)</p>
<p><strong>Design Principles:</strong></p>
<ul class="simple">
<li><p><strong>Immutability:</strong> Functions return new objects rather than modifying in-place</p></li>
<li><p><strong>Type Safety:</strong> Full type annotations on all public APIs</p></li>
<li><p><strong>Validation:</strong> Strict input validation with clear error messages</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="data-processing-modules">
<h3>Data Processing Modules<a class="headerlink" href="#data-processing-modules" title="Link to this heading">¶</a></h3>
<section id="normalization">
<h4>normalization/<a class="headerlink" href="#normalization" title="Link to this heading">¶</a></h4>
<p><strong>Responsibility:</strong> Transform data distributions (log transform, scaling, centering)</p>
<p><strong>Inputs:</strong> <code class="docutils literal notranslate"><span class="pre">ScpContainer</span></code> with source layer
<strong>Outputs:</strong> <code class="docutils literal notranslate"><span class="pre">ScpContainer</span></code> with new normalized layer
<strong>Side Effects:</strong> Updates <code class="docutils literal notranslate"><span class="pre">container.history</span></code> with operation log</p>
<p><strong>Methods:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">log_normalize()</span></code> - Log transform (base 2 by default)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sample_median_normalization()</span></code> - Median centering per sample</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sample_mean_normalization()</span></code> - Mean centering per sample</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">global_median_normalization()</span></code> - Global median centering</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tmm_normalization()</span></code> - TMM scaling (for between-sample normalization)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">upper_quartile_normalization()</span></code> - Upper quartile scaling</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">zscore_standardization()</span></code> - Z-score normalization</p></li>
</ul>
<p><strong>Data Contract:</strong></p>
<ul class="simple">
<li><p>Preserves sample/feature dimensions exactly</p></li>
<li><p>Creates new layer (does not modify source)</p></li>
<li><p>Returns <code class="docutils literal notranslate"><span class="pre">ScpContainer</span></code> (functional pattern)</p></li>
<li><p>Updates <code class="docutils literal notranslate"><span class="pre">ProvenanceLog</span></code> with operation details</p></li>
</ul>
<p><strong>Design Decision:</strong> Why multiple normalization methods?</p>
<p>Different SCP analysis workflows require different normalization strategies:</p>
<ul class="simple">
<li><p><strong>Log transform:</strong> Standard for proteomics intensity data</p></li>
<li><p><strong>Median centering:</strong> Removes sample-specific biases</p></li>
<li><p><strong>TMM:</strong> Effective for between-sample comparisons</p></li>
<li><p><strong>Z-score:</strong> Required for some downstream algorithms</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="impute">
<h4>impute/<a class="headerlink" href="#impute" title="Link to this heading">¶</a></h4>
<p><strong>Responsibility:</strong> Fill missing values using statistical/matrix methods</p>
<p><strong>Methods:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">knn()</span></code> - K-nearest neighbors imputation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ppca()</span></code> - Probabilistic PCA imputation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">svd()</span></code> - Singular value decomposition imputation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">missforest()</span></code> - Random forest-based imputation</p></li>
</ul>
<p><strong>Data Contract:</strong></p>
<ul class="simple">
<li><p><strong>Input:</strong> Layer with <code class="docutils literal notranslate"><span class="pre">M</span></code> mask (non-zero = missing)</p></li>
<li><p><strong>Output:</strong> Layer with <code class="docutils literal notranslate"><span class="pre">M</span></code> mask updated (all zeros = filled)</p></li>
<li><p><strong>Provenance:</strong> Original missing values marked as <code class="docutils literal notranslate"><span class="pre">IMPUTED</span></code> (5) in mask</p></li>
<li><p><strong>Sparsity:</strong> Preserves sparsity where possible</p></li>
<li><p><strong>Updates:</strong> <code class="docutils literal notranslate"><span class="pre">ProvenanceLog</span></code> with imputation parameters</p></li>
</ul>
<p><strong>Design Decision:</strong> Why 4 methods?</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Method</p></th>
<th class="head"><p>Strength</p></th>
<th class="head"><p>Use Case</p></th>
<th class="head"><p>Complexity</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>KNN</p></td>
<td><p>Fast, local similarity</p></td>
<td><p>Small datasets, quick prototyping</p></td>
<td><p>O(n²)</p></td>
</tr>
<tr class="row-odd"><td><p>PPCA</p></td>
<td><p>Global structure preservation</p></td>
<td><p>Large-scale missingness</p></td>
<td><p>O(n³)</p></td>
</tr>
<tr class="row-even"><td><p>SVD</p></td>
<td><p>Low-rank approximation</p></td>
<td><p>Matrix completion problems</p></td>
<td><p>O(n³)</p></td>
</tr>
<tr class="row-odd"><td><p>MissForest</p></td>
<td><p>Non-parametric</p></td>
<td><p>Complex missing patterns</p></td>
<td><p>O(n² log n)</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Implementation Notes:</strong></p>
<ul class="simple">
<li><p>All methods must handle both dense and sparse matrices</p></li>
<li><p>KNN should use efficient nearest neighbor algorithms (ball tree, kd-tree)</p></li>
<li><p>PPCA/SVD should use randomized SVD for large datasets</p></li>
<li><p>MissForest implementation should use scikit-learn’s RandomForestRegressor</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="integration">
<h4>integration/<a class="headerlink" href="#integration" title="Link to this heading">¶</a></h4>
<p><strong>Responsibility:</strong> Remove batch effects and merge multiple datasets</p>
<p><strong>Methods:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">combat()</span></code> - Empirical Bayes (ComBat)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">harmony()</span></code> - Iterative clustering-based correction</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mnn()</span></code> - Mutual nearest neighbors alignment</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">scanorama()</span></code> - Data fusion-based integration</p></li>
</ul>
<p><strong>Data Contract:</strong></p>
<ul class="simple">
<li><p><strong>Requires:</strong> <code class="docutils literal notranslate"><span class="pre">obs[batch_column]</span></code> for batch labels</p></li>
<li><p><strong>Modifies:</strong> Values in specified layer (creates new layer)</p></li>
<li><p><strong>Preserves:</strong> Biological variance (goal)</p></li>
<li><p><strong>Updates:</strong> <code class="docutils literal notranslate"><span class="pre">ProvenanceLog</span></code> with correction parameters</p></li>
</ul>
<p><strong>Design Decision:</strong> Why multiple integration methods?</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Method</p></th>
<th class="head"><p>Strength</p></th>
<th class="head"><p>Limitations</p></th>
<th class="head"><p>Best For</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ComBat</p></td>
<td><p>Proven, effective</p></td>
<td><p>Assumes linear batch effects</p></td>
<td><p>Simple batch structures</p></td>
</tr>
<tr class="row-odd"><td><p>Harmony</p></td>
<td><p>Preserves biological variance</p></td>
<td><p>Requires PCA first</p></td>
<td><p>Complex multi-batch data</p></td>
</tr>
<tr class="row-even"><td><p>MNN</p></td>
<td><p>Non-linear alignment</p></td>
<td><p>Slow for large datasets</p></td>
<td><p>Aligning diverse datasets</p></td>
</tr>
<tr class="row-odd"><td><p>Scanorama</p></td>
<td><p>Scalable data fusion</p></td>
<td><p>Complex hyperparameters</p></td>
<td><p>Large multi-batch studies</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Common Requirements:</strong></p>
<ul class="simple">
<li><p>All methods assume data is already normalized and log-transformed</p></li>
<li><p>All methods create new layer (don’t modify source)</p></li>
<li><p>All methods update <code class="docutils literal notranslate"><span class="pre">ProvenanceLog</span></code></p></li>
</ul>
</section>
<hr class="docutils" />
<section id="qc">
<h4>qc/<a class="headerlink" href="#qc" title="Link to this heading">¶</a></h4>
<p><strong>Responsibility:</strong> Identify and flag low-quality samples/features</p>
<p><strong>Methods:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">basic_qc()</span></code> - Missing rate, detection rate analysis</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">outlier_detection()</span></code> - Statistical outlier identification</p></li>
</ul>
<p><strong>Data Contract:</strong></p>
<ul class="simple">
<li><p><strong>Input:</strong> <code class="docutils literal notranslate"><span class="pre">ScpContainer</span></code> with data layer</p></li>
<li><p><strong>Output:</strong> <code class="docutils literal notranslate"><span class="pre">ScpContainer</span></code> with updated <code class="docutils literal notranslate"><span class="pre">obs</span></code> and <code class="docutils literal notranslate"><span class="pre">var</span></code></p></li>
<li><p><strong>Adds Columns:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">obs['completeness']</span></code> - Fraction of valid values per sample</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">obs['n_detected']</span></code> - Number of detected features per sample</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">obs['is_outlier']</span></code> - Boolean flag for outlier samples</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">var['completeness']</span></code> - Fraction of valid values per feature</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">var['n_samples_detected']</span></code> - Number of samples detecting each feature</p></li>
</ul>
</li>
<li><p><strong>Side Effects:</strong> None (only adds metadata, doesn’t filter)</p></li>
</ul>
<p><strong>Design Decision:</strong> Separation of concerns</p>
<p>QC methods <strong>identify</strong> issues but don’t <strong>filter</strong> them. Users make explicit filtering decisions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># QC identifies outliers</span>
<span class="n">container</span> <span class="o">=</span> <span class="n">basic_qc</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">assay_name</span><span class="o">=</span><span class="s1">&#39;proteins&#39;</span><span class="p">)</span>
<span class="n">container</span> <span class="o">=</span> <span class="n">outlier_detection</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;isolation_forest&#39;</span><span class="p">)</span>

<span class="c1"># User decides to filter</span>
<span class="n">outliers</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;is_outlier&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">container</span> <span class="o">=</span> <span class="n">filter_samples</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">sample_ids</span><span class="o">=</span><span class="n">outliers</span><span class="p">[</span><span class="s1">&#39;_index&#39;</span><span class="p">])</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="dim-reduction">
<h4>dim_reduction/<a class="headerlink" href="#dim-reduction" title="Link to this heading">¶</a></h4>
<p><strong>Responsibility:</strong> Reduce dimensionality for visualization and analysis</p>
<p><strong>Methods:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pca()</span></code> - Principal Component Analysis</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">umap()</span></code> - Uniform Manifold Approximation and Projection</p></li>
</ul>
<p><strong>Data Contract:</strong></p>
<ul class="simple">
<li><p><strong>Input:</strong> <code class="docutils literal notranslate"><span class="pre">ScpContainer</span></code> with source assay</p></li>
<li><p><strong>Output:</strong> <code class="docutils literal notranslate"><span class="pre">ScpContainer</span></code> with new assay containing embeddings</p></li>
<li><p><strong>New Assay Structure:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">assay.layers['scores']</span></code> - Embedding coordinates (n_samples × n_components)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">assay.var</span></code> contains metadata (explained_variance, loadings, etc.)</p></li>
</ul>
</li>
<li><p><strong>Creates:</strong> New assay (doesn’t modify source assay)</p></li>
</ul>
<p><strong>Design Decision:</strong> Why create new assay for embeddings?</p>
<p>Embeddings are first-class objects in ScpTensor:</p>
<ul class="simple">
<li><p>Can be further processed (e.g., UMAP on PCA)</p></li>
<li><p>Have their own metadata (variance explained, nearest neighbors)</p></li>
<li><p>Enable multiple reduction strategies on same data</p></li>
<li><p>Clear separation from original feature space</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="cluster">
<h4>cluster/<a class="headerlink" href="#cluster" title="Link to this heading">¶</a></h4>
<p><strong>Responsibility:</strong> Group samples into clusters</p>
<p><strong>Methods:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">run_kmeans()</span></code> - K-means clustering</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_leiden()</span></code> - Leiden graph clustering</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_louvain()</span></code> - Louvain graph clustering</p></li>
</ul>
<p><strong>Data Contract:</strong></p>
<ul class="simple">
<li><p><strong>Input:</strong> <code class="docutils literal notranslate"><span class="pre">ScpContainer</span></code> with embedding assay (usually PCA)</p></li>
<li><p><strong>Output:</strong> <code class="docutils literal notranslate"><span class="pre">ScpContainer</span></code> with updated <code class="docutils literal notranslate"><span class="pre">obs</span></code></p></li>
<li><p><strong>Adds Column:</strong> <code class="docutils literal notranslate"><span class="pre">obs[key_added]</span></code> with cluster labels (0, 1, 2, …)</p></li>
<li><p><strong>Side Effects:</strong> None (only adds labels to obs)</p></li>
</ul>
<p><strong>Design Decision:</strong> Separate cluster from dim_reduction</p>
<p>Clustering operates on <strong>embeddings</strong>, not raw data:</p>
<ul class="simple">
<li><p>More efficient</p></li>
<li><p>Standard workflow (PCA → cluster)</p></li>
<li><p>Enables clustering on any embedding (PCA, UMAP, etc.)</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="viz">
<h4>viz/<a class="headerlink" href="#viz" title="Link to this heading">¶</a></h4>
<p><strong>Responsibility:</strong> Generate publication-quality visualizations</p>
<p><strong>Methods:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">qc_completeness()</span></code> - Bar plot of data completeness</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">qc_matrix_spy()</span></code> - Spy plot of missing value patterns</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">embedding()</span></code> - Scatter plot of dimensionality reduction</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">heatmap()</span></code> - Heatmap of feature expression</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">volcano()</span></code> - Volcano plot for differential expression</p></li>
</ul>
<p><strong>Data Contract:</strong></p>
<ul class="simple">
<li><p><strong>Input:</strong> <code class="docutils literal notranslate"><span class="pre">ScpContainer</span></code> with relevant data</p></li>
<li><p><strong>Output:</strong> <code class="docutils literal notranslate"><span class="pre">matplotlib.pyplot.Axes</span></code> object</p></li>
<li><p><strong>Style:</strong> SciencePlots ([“science”, “no-latex”])</p></li>
<li><p><strong>DPI:</strong> 300 (publication quality)</p></li>
<li><p><strong>Language:</strong> English only (no Chinese characters)</p></li>
</ul>
<p><strong>Design Decision:</strong> Return Axes objects</p>
<p>Returns Axes for flexibility:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">embedding</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="s1">&#39;umap&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">embedding</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="s1">&#39;umap&#39;</span><span class="p">,</span> <span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;comparison.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>
<hr class="docutils" />
<section id="data-structure-specifications">
<h2>2. Data Structure Specifications<a class="headerlink" href="#data-structure-specifications" title="Link to this heading">¶</a></h2>
<section id="scpcontainer">
<h3>ScpContainer<a class="headerlink" href="#scpcontainer" title="Link to this heading">¶</a></h3>
<p><strong>Purpose:</strong> Top-level manager for multi-assay experiments</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScpContainer</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">obs</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">assays</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Assay</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">links</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">AggregationLink</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">history</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ProvenanceLog</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sample_id_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_index&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</pre></div>
</div>
<p><strong>Attributes:</strong></p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Attribute</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Mutability</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">obs</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">pl.DataFrame</span></code></p></td>
<td><p>Sample metadata (n_samples × metadata_cols)</p></td>
<td><p>Read-only view</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">assays</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Dict[str,</span> <span class="pre">Assay]</span></code></p></td>
<td><p>Assay registry (name → assay mapping)</p></td>
<td><p>Read-only view</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">links</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">List[AggregationLink]</span></code></p></td>
<td><p>Assay relationships</p></td>
<td><p>Read-only view</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">history</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">List[ProvenanceLog]</span></code></p></td>
<td><p>Operation audit trail</p></td>
<td><p>Read-only view</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">sample_id_col</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">str</span></code></p></td>
<td><p>Column name for unique sample IDs</p></td>
<td><p>Immutable</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">n_samples</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">int</span></code></p></td>
<td><p>Number of samples (property)</p></td>
<td><p>Computed</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">sample_ids</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">pl.Series</span></code></p></td>
<td><p>Sample ID column (property)</p></td>
<td><p>Computed</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Invariants:</strong></p>
<ol class="arabic">
<li><p><strong>Sample Dimension Consistency:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">For</span> <span class="nb">all</span> <span class="n">assays</span> <span class="n">A</span><span class="p">,</span> <span class="nb">all</span> <span class="n">layers</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">A</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
    <span class="n">L</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">obs</span><span class="o">.</span><span class="n">height</span>
</pre></div>
</div>
</li>
<li><p><strong>Unique Sample IDs:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">obs</span><span class="p">[</span><span class="n">sample_id_col</span><span class="p">]</span><span class="o">.</span><span class="n">n_unique</span><span class="p">()</span> <span class="o">==</span> <span class="n">obs</span><span class="o">.</span><span class="n">height</span>
</pre></div>
</div>
</li>
<li><p><strong>Valid Assay Links:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">For</span> <span class="nb">all</span> <span class="n">links</span> <span class="n">L</span><span class="p">:</span>
    <span class="n">L</span><span class="o">.</span><span class="n">source_assay</span> <span class="ow">in</span> <span class="n">assays</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">L</span><span class="o">.</span><span class="n">target_assay</span> <span class="ow">in</span> <span class="n">assays</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ol>
<p><strong>Methods:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">add_assay(name:</span> <span class="pre">str,</span> <span class="pre">assay:</span> <span class="pre">Assay)</span> <span class="pre">-&gt;</span> <span class="pre">None</span></code> - Register new assay</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log_operation(...)</span> <span class="pre">-&gt;</span> <span class="pre">None</span></code> - Add operation to history</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validate_links()</span> <span class="pre">-&gt;</span> <span class="pre">None</span></code> - Validate AggregationLink integrity</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">copy(deep:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">True)</span> <span class="pre">-&gt;</span> <span class="pre">ScpContainer</span></code> - Copy container</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deepcopy()</span> <span class="pre">-&gt;</span> <span class="pre">ScpContainer</span></code> - Deep copy</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shallow_copy()</span> <span class="pre">-&gt;</span> <span class="pre">ScpContainer</span></code> - Shallow copy (shared assays)</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="assay">
<h3>Assay<a class="headerlink" href="#assay" title="Link to this heading">¶</a></h3>
<p><strong>Purpose:</strong> Feature-space specific data manager</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Assay</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">var</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ScpMatrix</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">feature_id_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_index&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</pre></div>
</div>
<p><strong>Attributes:</strong></p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Attribute</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Mutability</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">var</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">pl.DataFrame</span></code></p></td>
<td><p>Feature metadata (n_features × metadata_cols)</p></td>
<td><p>Read-only view</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">layers</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Dict[str,</span> <span class="pre">ScpMatrix]</span></code></p></td>
<td><p>Data layers (name → matrix mapping)</p></td>
<td><p>Read-only view</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">feature_id_col</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">str</span></code></p></td>
<td><p>Column name for unique feature IDs</p></td>
<td><p>Immutable</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">n_features</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">int</span></code></p></td>
<td><p>Number of features (property)</p></td>
<td><p>Computed</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">feature_ids</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">pl.Series</span></code></p></td>
<td><p>Feature ID column (property)</p></td>
<td><p>Computed</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">X</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Union[np.ndarray,</span> <span class="pre">sp.spmatrix]</span></code></p></td>
<td><p>Shortcut to ‘X’ layer (property)</p></td>
<td><p>Computed</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Invariants:</strong></p>
<ol class="arabic">
<li><p><strong>Feature Dimension Consistency:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">For</span> <span class="nb">all</span> <span class="n">layers</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
    <span class="n">L</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">var</span><span class="o">.</span><span class="n">height</span>
</pre></div>
</div>
</li>
<li><p><strong>Unique Feature IDs:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span><span class="p">[</span><span class="n">feature_id_col</span><span class="p">]</span><span class="o">.</span><span class="n">n_unique</span><span class="p">()</span> <span class="o">==</span> <span class="n">var</span><span class="o">.</span><span class="n">height</span>
</pre></div>
</div>
</li>
<li><p><strong>Layer Naming Convention:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Common</span> <span class="n">layer</span> <span class="n">names</span><span class="p">:</span> <span class="s1">&#39;raw&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;imputed&#39;</span><span class="p">,</span> <span class="s1">&#39;corrected&#39;</span><span class="p">,</span> <span class="s1">&#39;scaled&#39;</span>
</pre></div>
</div>
</li>
</ol>
<p><strong>Methods:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">add_layer(name:</span> <span class="pre">str,</span> <span class="pre">matrix:</span> <span class="pre">ScpMatrix)</span> <span class="pre">-&gt;</span> <span class="pre">None</span></code> - Add data layer</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">subset(feature_indices,</span> <span class="pre">copy_data=True)</span> <span class="pre">-&gt;</span> <span class="pre">Assay</span></code> - Subset features</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get_layer(layer_name:</span> <span class="pre">str)</span> <span class="pre">-&gt;</span> <span class="pre">ScpMatrix</span></code> - Get layer with validation</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="scpmatrix">
<h3>ScpMatrix<a class="headerlink" href="#scpmatrix" title="Link to this heading">¶</a></h3>
<p><strong>Purpose:</strong> Physical storage with provenance tracking via mask</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ScpMatrix</span><span class="p">:</span>
    <span class="n">X</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">spmatrix</span><span class="p">]</span>           <span class="c1"># Quantitative values</span>
    <span class="n">M</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">spmatrix</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>     <span class="c1"># Mask codes</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MatrixMetadata</span><span class="p">]</span>          <span class="c1"># Quality scores</span>
</pre></div>
</div>
<p><strong>Attributes:</strong></p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Attribute</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Constraints</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">X</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">np.ndarray</span></code> or <code class="docutils literal notranslate"><span class="pre">sp.spmatrix</span></code></p></td>
<td><p>Quantitative values</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">dtype</span></code> must be <code class="docutils literal notranslate"><span class="pre">float64</span></code> or <code class="docutils literal notranslate"><span class="pre">float32</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">M</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">np.ndarray</span></code>, <code class="docutils literal notranslate"><span class="pre">sp.spmatrix</span></code>, or <code class="docutils literal notranslate"><span class="pre">None</span></code></p></td>
<td><p>Mask codes</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">dtype</span></code> must be <code class="docutils literal notranslate"><span class="pre">int8</span></code> if present</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">metadata</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">MatrixMetadata</span></code> or <code class="docutils literal notranslate"><span class="pre">None</span></code></p></td>
<td><p>Quality metadata</p></td>
<td><p>Optional</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Invariants:</strong></p>
<ol class="arabic">
<li><p><strong>Shape Consistency:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">M</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">X</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</li>
<li><p><strong>Valid Mask Codes:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">M</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">all</span><span class="p">(</span><span class="n">M</span> <span class="n">values</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">})</span>
</pre></div>
</div>
</li>
<li><p><strong>Floating Point X:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span>
</pre></div>
</div>
</li>
</ol>
<p><strong>MaskCode Enum:</strong></p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Code</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>VALID</p></td>
<td><p>Valid detected value</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>MBR</p></td>
<td><p>Missing Between Runs</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>LOD</p></td>
<td><p>Below Limit of Detection</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>FILTERED</p></td>
<td><p>Filtered out by QC</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>OUTLIER</p></td>
<td><p>Statistical outlier</p></td>
</tr>
<tr class="row-odd"><td><p>5</p></td>
<td><p>IMPUTED</p></td>
<td><p>Imputed/filled value</p></td>
</tr>
<tr class="row-even"><td><p>6</p></td>
<td><p>UNCERTAIN</p></td>
<td><p>Uncertain data quality</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Methods:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">get_m()</span> <span class="pre">-&gt;</span> <span class="pre">Union[np.ndarray,</span> <span class="pre">sp.spmatrix]</span></code> - Get mask (zeros if None)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">copy()</span> <span class="pre">-&gt;</span> <span class="pre">ScpMatrix</span></code> - Deep copy</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="aggregationlink">
<h3>AggregationLink<a class="headerlink" href="#aggregationlink" title="Link to this heading">¶</a></h3>
<p><strong>Purpose:</strong> Define relationships between assays (e.g., peptide → protein)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AggregationLink</span><span class="p">:</span>
    <span class="n">source_assay</span><span class="p">:</span> <span class="nb">str</span>                    <span class="c1"># Source assay name</span>
    <span class="n">target_assay</span><span class="p">:</span> <span class="nb">str</span>                    <span class="c1"># Target assay name</span>
    <span class="n">linkage</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span>                <span class="c1"># Mapping table</span>
</pre></div>
</div>
<p><strong>Required Columns in <code class="docutils literal notranslate"><span class="pre">linkage</span></code>:</strong></p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Column</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">source_id</span></code></p></td>
<td><p>str</p></td>
<td><p>Feature ID in source assay</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">target_id</span></code></p></td>
<td><p>str</p></td>
<td><p>Feature ID in target assay</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Invariants:</strong></p>
<ol class="arabic">
<li><p><strong>Valid Assays:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source_assay</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">assays</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="n">target_assay</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">assays</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p><strong>Valid Feature IDs:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">all</span><span class="p">(</span><span class="n">linkage</span><span class="p">[</span><span class="s1">&#39;source_id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">assays</span><span class="p">[</span><span class="n">source_assay</span><span class="p">]</span><span class="o">.</span><span class="n">feature_ids</span><span class="p">)</span>
<span class="nb">all</span><span class="p">(</span><span class="n">linkage</span><span class="p">[</span><span class="s1">&#39;target_id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">assays</span><span class="p">[</span><span class="n">target_assay</span><span class="p">]</span><span class="o">.</span><span class="n">feature_ids</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</section>
<hr class="docutils" />
<section id="provenancelog">
<h3>ProvenanceLog<a class="headerlink" href="#provenancelog" title="Link to this heading">¶</a></h3>
<p><strong>Purpose:</strong> Track all operations for reproducibility</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ProvenanceLog</span><span class="p">:</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">str</span>                          <span class="c1"># ISO format timestamp</span>
    <span class="n">action</span><span class="p">:</span> <span class="nb">str</span>                             <span class="c1"># Operation name</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>                  <span class="c1"># Operation parameters</span>
    <span class="n">software_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>         <span class="c1"># ScpTensor version</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>              <span class="c1"># Human-readable description</span>
</pre></div>
</div>
<p><strong>Example:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ProvenanceLog</span><span class="p">(</span>
    <span class="n">timestamp</span><span class="o">=</span><span class="s2">&quot;2025-01-05T14:30:00&quot;</span><span class="p">,</span>
    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;log_normalize&quot;</span><span class="p">,</span>
    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;base&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span>
    <span class="n">software_version</span><span class="o">=</span><span class="s2">&quot;0.1.0-beta&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Log2 transform with offset 1.0&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="design-patterns">
<h2>3. Design Patterns<a class="headerlink" href="#design-patterns" title="Link to this heading">¶</a></h2>
<section id="pattern-1-immutable-layer-creation">
<h3>Pattern 1: Immutable Layer Creation<a class="headerlink" href="#pattern-1-immutable-layer-creation" title="Link to this heading">¶</a></h3>
<p><strong>Problem:</strong> Tracking data transformations through analysis pipeline</p>
<p><strong>Solution:</strong> Functions create new layers, never modify in-place</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Good: Functional pattern</span>
<span class="n">container</span> <span class="o">=</span> <span class="n">log_normalize</span><span class="p">(</span>
    <span class="n">container</span><span class="p">,</span>
    <span class="n">assay_name</span><span class="o">=</span><span class="s2">&quot;proteins&quot;</span><span class="p">,</span>
    <span class="n">base_layer</span><span class="o">=</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span>
    <span class="n">new_layer_name</span><span class="o">=</span><span class="s2">&quot;log&quot;</span>
<span class="p">)</span>
<span class="c1"># Creates: container.assays[&#39;proteins&#39;].layers[&#39;log&#39;]</span>
<span class="c1"># Preserves: container.assays[&#39;proteins&#39;].layers[&#39;raw&#39;]</span>

<span class="c1"># Bad: In-place modification (breaks reproducibility)</span>
<span class="n">container</span><span class="o">.</span><span class="n">assays</span><span class="p">[</span><span class="s1">&#39;proteins&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span>
<span class="c1"># No provenance tracking</span>
</pre></div>
</div>
<p><strong>Rationale:</strong></p>
<ul class="simple">
<li><p>Enables full reproducibility via <code class="docutils literal notranslate"><span class="pre">ProvenanceLog</span></code></p></li>
<li><p>Users can compare different normalization strategies</p></li>
<li><p>Easy rollback to previous layers</p></li>
<li><p>Clear data lineage</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="pattern-2-mask-based-provenance">
<h3>Pattern 2: Mask-Based Provenance<a class="headerlink" href="#pattern-2-mask-based-provenance" title="Link to this heading">¶</a></h3>
<p><strong>Problem:</strong> Knowing which values are original vs. imputed vs. filtered</p>
<p><strong>Solution:</strong> Mask matrix tracks data status independently from values</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Before imputation</span>
<span class="n">X</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>        <span class="c1"># Placeholder</span>
<span class="n">M</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>          <span class="c1"># MBR (missing)</span>

<span class="c1"># After KNN imputation</span>
<span class="n">X</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mf">12.3</span>       <span class="c1"># Filled value</span>
<span class="n">M</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>          <span class="c1"># IMPUTED</span>

<span class="c1"># Downstream analysis can filter/weight by provenance</span>
<span class="n">valid_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>           <span class="c1"># Only original detected values</span>
<span class="n">imputed_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>         <span class="c1"># Only imputed values</span>
</pre></div>
</div>
<p><strong>Rationale:</strong></p>
<ul class="simple">
<li><p>Downstream methods can treat imputed values differently</p></li>
<li><p>Enables sensitivity analysis (with/without imputed values)</p></li>
<li><p>Clear audit trail for publications</p></li>
<li><p>Quality control transparency</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="pattern-3-assay-aggregation-links">
<h3>Pattern 3: Assay-Aggregation Links<a class="headerlink" href="#pattern-3-assay-aggregation-links" title="Link to this heading">¶</a></h3>
<p><strong>Problem:</strong> Relating peptide-level data to protein-level data</p>
<p><strong>Solution:</strong> Explicit <code class="docutils literal notranslate"><span class="pre">AggregationLink</span></code> objects with mapping tables</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">link</span> <span class="o">=</span> <span class="n">AggregationLink</span><span class="p">(</span>
    <span class="n">source_assay</span><span class="o">=</span><span class="s2">&quot;peptides&quot;</span><span class="p">,</span>
    <span class="n">target_assay</span><span class="o">=</span><span class="s2">&quot;proteins&quot;</span><span class="p">,</span>
    <span class="n">linkage</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s2">&quot;source_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;PEP001&quot;</span><span class="p">,</span> <span class="s2">&quot;PEP002&quot;</span><span class="p">,</span> <span class="s2">&quot;PEP003&quot;</span><span class="p">,</span> <span class="s2">&quot;PEP004&quot;</span><span class="p">],</span>
        <span class="s2">&quot;target_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;PROT001&quot;</span><span class="p">,</span> <span class="s2">&quot;PROT001&quot;</span><span class="p">,</span> <span class="s2">&quot;PROT002&quot;</span><span class="p">,</span> <span class="s2">&quot;PROT002&quot;</span><span class="p">]</span>
    <span class="p">})</span>
<span class="p">)</span>

<span class="c1"># Usage: Aggregate peptides to proteins</span>
<span class="n">container</span><span class="o">.</span><span class="n">aggregage_proteins</span><span class="p">(</span>
    <span class="n">link</span><span class="o">=</span><span class="n">link</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
    <span class="n">new_assay_name</span><span class="o">=</span><span class="s2">&quot;proteins&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p><strong>Rationale:</strong></p>
<ul class="simple">
<li><p>Flexible many-to-many mappings (isoforms → protein)</p></li>
<li><p>Preserves mapping for reproducibility</p></li>
<li><p>Enables different aggregation strategies (sum, mean, max)</p></li>
<li><p>Clear audit trail</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="pattern-4-functional-pipeline-design">
<h3>Pattern 4: Functional Pipeline Design<a class="headerlink" href="#pattern-4-functional-pipeline-design" title="Link to this heading">¶</a></h3>
<p><strong>Problem:</strong> Building complex analysis pipelines</p>
<p><strong>Solution:</strong> All functions accept <code class="docutils literal notranslate"><span class="pre">ScpContainer</span></code>, return modified <code class="docutils literal notranslate"><span class="pre">ScpContainer</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pipeline: Raw → Normalized → Imputed → Corrected → Clustered</span>
<span class="n">container</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">container</span>
    <span class="o">|&gt;</span> <span class="n">log_normalize</span><span class="p">(</span><span class="n">assay_name</span><span class="o">=</span><span class="s2">&quot;proteins&quot;</span><span class="p">,</span> <span class="n">base_layer</span><span class="o">=</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="n">new_layer_name</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="n">knn</span><span class="p">(</span><span class="n">assay_name</span><span class="o">=</span><span class="s2">&quot;proteins&quot;</span><span class="p">,</span> <span class="n">base_layer</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">new_layer_name</span><span class="o">=</span><span class="s2">&quot;imputed&quot;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="n">combat</span><span class="p">(</span><span class="n">batch_key</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">,</span> <span class="n">assay_name</span><span class="o">=</span><span class="s2">&quot;proteins&quot;</span><span class="p">,</span> <span class="n">base_layer</span><span class="o">=</span><span class="s2">&quot;imputed&quot;</span><span class="p">,</span> <span class="n">new_layer_name</span><span class="o">=</span><span class="s2">&quot;corrected&quot;</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="n">pca</span><span class="p">(</span><span class="n">assay_name</span><span class="o">=</span><span class="s2">&quot;proteins&quot;</span><span class="p">,</span> <span class="n">base_layer_name</span><span class="o">=</span><span class="s2">&quot;corrected&quot;</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="n">run_kmeans</span><span class="p">(</span><span class="n">assay_name</span><span class="o">=</span><span class="s2">&quot;pca&quot;</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Alternative: Standard Python</span>
<span class="n">container</span> <span class="o">=</span> <span class="n">log_normalize</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">assay_name</span><span class="o">=</span><span class="s2">&quot;proteins&quot;</span><span class="p">,</span> <span class="n">base_layer</span><span class="o">=</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="n">new_layer_name</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">container</span> <span class="o">=</span> <span class="n">knn</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">assay_name</span><span class="o">=</span><span class="s2">&quot;proteins&quot;</span><span class="p">,</span> <span class="n">base_layer</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">new_layer_name</span><span class="o">=</span><span class="s2">&quot;imputed&quot;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">container</span> <span class="o">=</span> <span class="n">combat</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">batch_key</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">,</span> <span class="n">assay_name</span><span class="o">=</span><span class="s2">&quot;proteins&quot;</span><span class="p">,</span> <span class="n">base_layer</span><span class="o">=</span><span class="s2">&quot;imputed&quot;</span><span class="p">,</span> <span class="n">new_layer_name</span><span class="o">=</span><span class="s2">&quot;corrected&quot;</span><span class="p">)</span>
<span class="n">container</span> <span class="o">=</span> <span class="n">pca</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">assay_name</span><span class="o">=</span><span class="s2">&quot;proteins&quot;</span><span class="p">,</span> <span class="n">base_layer_name</span><span class="o">=</span><span class="s2">&quot;corrected&quot;</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">container</span> <span class="o">=</span> <span class="n">run_kmeans</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">assay_name</span><span class="o">=</span><span class="s2">&quot;pca&quot;</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Rationale:</strong></p>
<ul class="simple">
<li><p>Composable operations</p></li>
<li><p>Easy to insert/remove steps</p></li>
<li><p>Clear data flow</p></li>
<li><p>Testable individual components</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="integration-patterns">
<h2>4. Integration Patterns<a class="headerlink" href="#integration-patterns" title="Link to this heading">¶</a></h2>
<section id="pattern-a-sequential-processing">
<h3>Pattern A: Sequential Processing<a class="headerlink" href="#pattern-a-sequential-processing" title="Link to this heading">¶</a></h3>
<p><strong>Most common workflow:</strong> Data flows through modules sequentially</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Raw Data
  → QC (identify outliers)
  → Normalization (log transform)
  → Imputation (fill missing)
  → Integration (batch correction)
  → Dimensionality Reduction (PCA)
  → Clustering (KMeans)
  → Visualization
</pre></div>
</div>
<p><strong>Key Points:</strong></p>
<ul class="simple">
<li><p>Each step creates new layer</p></li>
<li><p>Original data preserved</p></li>
<li><p>Easy to backtrack</p></li>
<li><p>Provenance automatically tracked</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="pattern-b-branching-workflows">
<h3>Pattern B: Branching Workflows<a class="headerlink" href="#pattern-b-branching-workflows" title="Link to this heading">¶</a></h3>
<p><strong>Multiple preprocessing strategies compared:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Strategy 1: KNN imputation</span>
<span class="n">container_knn</span> <span class="o">=</span> <span class="n">container</span> <span class="o">|&gt;</span> <span class="n">log_normalize</span><span class="p">()</span> <span class="o">|&gt;</span> <span class="n">knn</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Strategy 2: PPCA imputation</span>
<span class="n">container_ppca</span> <span class="o">=</span> <span class="n">container</span> <span class="o">|&gt;</span> <span class="n">log_normalize</span><span class="p">()</span> <span class="o">|&gt;</span> <span class="n">ppca</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Compare results</span>
<span class="n">compare_results</span><span class="p">(</span><span class="n">container_knn</span><span class="p">,</span> <span class="n">container_ppca</span><span class="p">)</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="pattern-c-multi-assay-analysis">
<h3>Pattern C: Multi-Assay Analysis<a class="headerlink" href="#pattern-c-multi-assay-analysis" title="Link to this heading">¶</a></h3>
<p><strong>Analyze both peptides and proteins:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Container with two assays</span>
<span class="n">container</span> <span class="o">=</span> <span class="n">ScpContainer</span><span class="p">(</span>
    <span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span>
    <span class="n">assays</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;peptides&quot;</span><span class="p">:</span> <span class="n">peptide_assay</span><span class="p">,</span>
        <span class="s2">&quot;proteins&quot;</span><span class="p">:</span> <span class="n">protein_assay</span>
    <span class="p">},</span>
    <span class="n">links</span><span class="o">=</span><span class="p">[</span><span class="n">peptide_to_protein_link</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Analyze separately</span>
<span class="n">container</span> <span class="o">=</span> <span class="n">log_normalize</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">assay_name</span><span class="o">=</span><span class="s2">&quot;peptides&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">container</span> <span class="o">=</span> <span class="n">log_normalize</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">assay_name</span><span class="o">=</span><span class="s2">&quot;proteins&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>

<span class="c1"># Aggregate peptides to proteins</span>
<span class="n">container</span> <span class="o">=</span> <span class="n">aggregate</span><span class="p">(</span>
    <span class="n">container</span><span class="p">,</span>
    <span class="n">link</span><span class="o">=</span><span class="n">peptide_to_protein_link</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="error-handling-strategy">
<h2>5. Error Handling Strategy<a class="headerlink" href="#error-handling-strategy" title="Link to this heading">¶</a></h2>
<section id="error-hierarchy">
<h3>Error Hierarchy<a class="headerlink" href="#error-hierarchy" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScpTensorError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base exception for all ScpTensor errors&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">StructureError</span><span class="p">(</span><span class="n">ScpTensorError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Data structure inconsistency&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ValidationError</span><span class="p">(</span><span class="n">ScpTensorError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Input validation failure&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LayerNotFoundError</span><span class="p">(</span><span class="n">ScpTensorError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Requested layer doesn&#39;t exist&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AssayNotFoundError</span><span class="p">(</span><span class="n">ScpTensorError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Requested assay doesn&#39;t exist&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</pre></div>
</div>
</section>
<section id="validation-strategy">
<h3>Validation Strategy<a class="headerlink" href="#validation-strategy" title="Link to this heading">¶</a></h3>
<p><strong>Preconditions:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">log_normalize</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">assay_name</span><span class="p">,</span> <span class="n">base_layer</span><span class="p">,</span> <span class="n">new_layer_name</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
    <span class="c1"># Validate assay exists</span>
    <span class="k">if</span> <span class="n">assay_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">assays</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AssayNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assay &#39;</span><span class="si">{</span><span class="n">assay_name</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>

    <span class="c1"># Validate base layer exists</span>
    <span class="k">if</span> <span class="n">base_layer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">assays</span><span class="p">[</span><span class="n">assay_name</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">LayerNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Layer &#39;</span><span class="si">{</span><span class="n">base_layer</span><span class="si">}</span><span class="s2">&#39; not found in assay &#39;</span><span class="si">{</span><span class="n">assay_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Validate data is positive (for log)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">assays</span><span class="p">[</span><span class="n">assay_name</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">base_layer</span><span class="p">]</span><span class="o">.</span><span class="n">X</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">X</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Log transform requires non-negative values&quot;</span><span class="p">)</span>

    <span class="c1"># Proceed with computation</span>
    <span class="o">...</span>
</pre></div>
</div>
<p><strong>Postconditions:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># After computation, validate output</span>
    <span class="k">if</span> <span class="n">new_layer</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">input_shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">StructureError</span><span class="p">(</span><span class="s2">&quot;Output shape mismatch&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">new_layer</span><span class="o">.</span><span class="n">X</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">StructureError</span><span class="p">(</span><span class="s2">&quot;Output contains NaN values&quot;</span><span class="p">)</span>

    <span class="c1"># Add to history</span>
    <span class="n">container</span><span class="o">.</span><span class="n">log_operation</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">container</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="performance-considerations">
<h2>6. Performance Considerations<a class="headerlink" href="#performance-considerations" title="Link to this heading">¶</a></h2>
<section id="sparsity">
<h3>Sparsity<a class="headerlink" href="#sparsity" title="Link to this heading">¶</a></h3>
<p><strong>ScpTensor supports both dense and sparse matrices:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dense: For small/complete datasets</span>
<span class="n">X_dense</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">matrix</span> <span class="o">=</span> <span class="n">ScpMatrix</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X_dense</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># Sparse: For large/sparse datasets (SCP typical)</span>
<span class="n">X_sparse</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_features</span><span class="p">))</span>
<span class="n">matrix</span> <span class="o">=</span> <span class="n">ScpMatrix</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X_sparse</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">M_sparse</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Best Practices:</strong></p>
<ul class="simple">
<li><p>Use sparse matrices when missing rate &gt; 50%</p></li>
<li><p>Preserve sparsity through pipeline (avoid <code class="docutils literal notranslate"><span class="pre">.toarray()</span></code>)</p></li>
<li><p>KNN should support sparse inputs (use sparse distance metrics)</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="memory-management">
<h3>Memory Management<a class="headerlink" href="#memory-management" title="Link to this heading">¶</a></h3>
<p><strong>Layer copying:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Immutable pattern creates copies (memory overhead)</span>
<span class="n">container</span> <span class="o">=</span> <span class="n">log_normalize</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>  <span class="c1"># Creates new layer</span>

<span class="c1"># For large datasets, consider removing old layers</span>
<span class="k">del</span> <span class="n">container</span><span class="o">.</span><span class="n">assays</span><span class="p">[</span><span class="s1">&#39;proteins&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span>  <span class="c1"># Free memory</span>
</pre></div>
</div>
<p><strong>Recommendation:</strong> Implement <code class="docutils literal notranslate"><span class="pre">cleanup_layers()</span></code> utility</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">cleanup_layers</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">assay_name</span><span class="p">,</span> <span class="n">keep_layers</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove all layers except specified ones&quot;&quot;&quot;</span>
    <span class="n">assay</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">assays</span><span class="p">[</span><span class="n">assay_name</span><span class="p">]</span>
    <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">assay</span><span class="o">.</span><span class="n">layers</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep_layers</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">assay</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">container</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="numba-jit">
<h3>Numba JIT<a class="headerlink" href="#numba-jit" title="Link to this heading">¶</a></h3>
<p><strong>Target operations for JIT compilation:</strong></p>
<ol class="arabic simple">
<li><p><strong>Mask operations:</strong> Fast iteration over mask codes</p></li>
<li><p><strong>Distance computations:</strong> KNN imputation distance calculations</p></li>
<li><p><strong>Matrix operations:</strong> Custom matrix functions not in NumPy/SciPy</p></li>
</ol>
<p><strong>Example:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">numba</span><span class="w"> </span><span class="kn">import</span> <span class="n">jit</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">count_mask_codes</span><span class="p">(</span><span class="n">M</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fast count of each mask code&quot;&quot;&quot;</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>  <span class="c1"># 7 mask codes</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">counts</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="extension-points">
<h2>7. Extension Points<a class="headerlink" href="#extension-points" title="Link to this heading">¶</a></h2>
<section id="adding-new-normalization-methods">
<h3>Adding New Normalization Methods<a class="headerlink" href="#adding-new-normalization-methods" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. Create function in normalization/your_method.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">your_normalize</span><span class="p">(</span>
    <span class="n">container</span><span class="p">:</span> <span class="n">ScpContainer</span><span class="p">,</span>
    <span class="n">assay_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">base_layer</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">new_layer_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;your_normalized&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">params</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScpContainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Your normalization method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    container : ScpContainer</span>
<span class="sd">        Input container</span>
<span class="sd">    assay_name : str</span>
<span class="sd">        Target assay name</span>
<span class="sd">    base_layer : str</span>
<span class="sd">        Source layer name</span>
<span class="sd">    new_layer_name : str, optional</span>
<span class="sd">        New layer name</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ScpContainer</span>
<span class="sd">        Container with new normalized layer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate inputs</span>
    <span class="n">assay</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">assays</span><span class="p">[</span><span class="n">assay_name</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">base_layer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">assay</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">LayerNotFoundError</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="c1"># Apply normalization</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">assay</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">base_layer</span><span class="p">]</span><span class="o">.</span><span class="n">X</span>
    <span class="n">X_norm</span> <span class="o">=</span> <span class="n">your_algorithm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># Create new layer</span>
    <span class="n">new_layer</span> <span class="o">=</span> <span class="n">ScpMatrix</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X_norm</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">assay</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">base_layer</span><span class="p">]</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
    <span class="n">assay</span><span class="o">.</span><span class="n">add_layer</span><span class="p">(</span><span class="n">new_layer_name</span><span class="p">,</span> <span class="n">new_layer</span><span class="p">)</span>

    <span class="c1"># Log operation</span>
    <span class="n">container</span><span class="o">.</span><span class="n">log_operation</span><span class="p">(</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;your_normalize&quot;</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Your normalization method&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">container</span>

<span class="c1"># 2. Export in normalization/__init__.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.your_method</span><span class="w"> </span><span class="kn">import</span> <span class="n">your_normalize</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="s2">&quot;your_normalize&quot;</span><span class="p">]</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="adding-new-imputation-methods">
<h3>Adding New Imputation Methods<a class="headerlink" href="#adding-new-imputation-methods" title="Link to this heading">¶</a></h3>
<p>Follow same pattern as normalization:</p>
<ol class="arabic simple">
<li><p>Create function in <code class="docutils literal notranslate"><span class="pre">impute/your_method.py</span></code></p></li>
<li><p>Accept <code class="docutils literal notranslate"><span class="pre">ScpContainer</span></code>, return <code class="docutils literal notranslate"><span class="pre">ScpContainer</span></code></p></li>
<li><p>Update mask: <code class="docutils literal notranslate"><span class="pre">M[missing]</span> <span class="pre">=</span> <span class="pre">MaskCode.IMPUTED.value</span></code></p></li>
<li><p>Export in <code class="docutils literal notranslate"><span class="pre">impute/__init__.py</span></code></p></li>
</ol>
</section>
<hr class="docutils" />
<section id="adding-new-integration-methods">
<h3>Adding New Integration Methods<a class="headerlink" href="#adding-new-integration-methods" title="Link to this heading">¶</a></h3>
<p>Follow same pattern:</p>
<ol class="arabic simple">
<li><p>Create function in <code class="docutils literal notranslate"><span class="pre">integration/your_method.py</span></code></p></li>
<li><p>Require <code class="docutils literal notranslate"><span class="pre">batch_key</span></code> parameter for <code class="docutils literal notranslate"><span class="pre">obs[batch_column]</span></code></p></li>
<li><p>Create new layer with corrected values</p></li>
<li><p>Export in <code class="docutils literal notranslate"><span class="pre">integration/__init__.py</span></code></p></li>
</ol>
</section>
</section>
<hr class="docutils" />
<section id="testing-strategy">
<h2>8. Testing Strategy<a class="headerlink" href="#testing-strategy" title="Link to this heading">¶</a></h2>
<section id="unit-test-structure">
<h3>Unit Test Structure<a class="headerlink" href="#unit-test-structure" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># tests/core/test_structures.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scptensor.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScpContainer</span><span class="p">,</span> <span class="n">Assay</span><span class="p">,</span> <span class="n">ScpMatrix</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestScpMatrix</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_shape_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;M should have same shape as X&quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">ScpMatrix</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">M</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">matrix</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">matrix</span><span class="o">.</span><span class="n">M</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_mask_code_raises</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Invalid mask codes should raise ValueError&quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="mi">99</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>  <span class="c1"># Invalid code</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">ScpMatrix</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">M</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestAssay</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_subset_preserves_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Subsetting should return correct number of features&quot;&quot;&quot;</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;P</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]})</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">assay</span> <span class="o">=</span> <span class="n">Assay</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">ScpMatrix</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">)})</span>

        <span class="n">subset</span> <span class="o">=</span> <span class="n">assay</span><span class="o">.</span><span class="n">subset</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">subset</span><span class="o">.</span><span class="n">n_features</span> <span class="o">==</span> <span class="mi">3</span>
</pre></div>
</div>
</section>
<section id="integration-test-structure">
<h3>Integration Test Structure<a class="headerlink" href="#integration-test-structure" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># tests/integration/test_pipeline.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_full_pipeline</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test complete analysis pipeline&quot;&quot;&quot;</span>
    <span class="c1"># Generate synthetic data</span>
    <span class="n">container</span> <span class="o">=</span> <span class="n">generate_synthetic_data</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

    <span class="c1"># Run pipeline</span>
    <span class="n">container</span> <span class="o">=</span> <span class="n">log_normalize</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">assay_name</span><span class="o">=</span><span class="s2">&quot;proteins&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="n">container</span> <span class="o">=</span> <span class="n">knn</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">assay_name</span><span class="o">=</span><span class="s2">&quot;proteins&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="n">container</span> <span class="o">=</span> <span class="n">combat</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">batch_key</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="n">container</span> <span class="o">=</span> <span class="n">pca</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">assay_name</span><span class="o">=</span><span class="s2">&quot;proteins&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="n">container</span> <span class="o">=</span> <span class="n">run_kmeans</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">assay_name</span><span class="o">=</span><span class="s2">&quot;pca&quot;</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Validate results</span>
    <span class="k">assert</span> <span class="s2">&quot;log&quot;</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">assays</span><span class="p">[</span><span class="s2">&quot;proteins&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span>
    <span class="k">assert</span> <span class="s2">&quot;imputed&quot;</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">assays</span><span class="p">[</span><span class="s2">&quot;proteins&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span>
    <span class="k">assert</span> <span class="s2">&quot;corrected&quot;</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">assays</span><span class="p">[</span><span class="s2">&quot;proteins&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span>
    <span class="k">assert</span> <span class="s2">&quot;pca&quot;</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">assays</span>
    <span class="k">assert</span> <span class="s2">&quot;kmeans_cluster&quot;</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="deprecation-policy">
<h2>9. Deprecation Policy<a class="headerlink" href="#deprecation-policy" title="Link to this heading">¶</a></h2>
<section id="versioning">
<h3>Versioning<a class="headerlink" href="#versioning" title="Link to this heading">¶</a></h3>
<p>ScpTensor follows Semantic Versioning 2.0.0:</p>
<ul class="simple">
<li><p><strong>MAJOR:</strong> Incompatible API changes</p></li>
<li><p><strong>MINOR:</strong> Backwards-compatible functionality</p></li>
<li><p><strong>PATCH:</strong> Backwards-compatible bug fixes</p></li>
</ul>
</section>
<section id="deprecation-process">
<h3>Deprecation Process<a class="headerlink" href="#deprecation-process" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p><strong>Mark as deprecated:</strong></p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">old_function</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    .. deprecated:: 0.2.0</span>
<span class="sd">        old_function is deprecated and will be removed in v0.3.0.</span>
<span class="sd">        Use new_function instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s2">&quot;old_function is deprecated, use new_function&quot;</span><span class="p">,</span>
        <span class="ne">DeprecationWarning</span><span class="p">,</span>
        <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p><strong>Document in API_REFERENCE.md</strong> under “Deprecation Timeline”</p></li>
<li><p><strong>Remove in next MAJOR version</strong></p></li>
</ol>
</section>
</section>
<hr class="docutils" />
<section id="appendix">
<h2>Appendix<a class="headerlink" href="#appendix" title="Link to this heading">¶</a></h2>
<section id="a-type-annotation-standards">
<h3>A. Type Annotation Standards<a class="headerlink" href="#a-type-annotation-standards" title="Link to this heading">¶</a></h3>
<p>All public APIs must have complete type annotations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>

<span class="k">def</span><span class="w"> </span><span class="nf">example_function</span><span class="p">(</span>
    <span class="n">container</span><span class="p">:</span> <span class="n">ScpContainer</span><span class="p">,</span>
    <span class="n">assay_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScpContainer</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="b-naming-conventions">
<h3>B. Naming Conventions<a class="headerlink" href="#b-naming-conventions" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Modules:</strong> lowercase_with_underscores (e.g., <code class="docutils literal notranslate"><span class="pre">dim_reduction</span></code>)</p></li>
<li><p><strong>Classes:</strong> CapitalizedWords (e.g., <code class="docutils literal notranslate"><span class="pre">ScpContainer</span></code>)</p></li>
<li><p><strong>Functions:</strong> lowercase_with_underscores (e.g., <code class="docutils literal notranslate"><span class="pre">log_normalize</span></code>)</p></li>
<li><p><strong>Constants:</strong> UPPER_CASE (e.g., <code class="docutils literal notranslate"><span class="pre">DEFAULT_OFFSET</span></code>)</p></li>
<li><p><strong>Private:</strong> _leading_underscore (e.g., <code class="docutils literal notranslate"><span class="pre">_internal_helper</span></code>)</p></li>
</ul>
</section>
<section id="c-documentation-standards">
<h3>C. Documentation Standards<a class="headerlink" href="#c-documentation-standards" title="Link to this heading">¶</a></h3>
<p>All public functions must have NumPy-style docstrings:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">log_normalize</span><span class="p">(</span>
    <span class="n">container</span><span class="p">:</span> <span class="n">ScpContainer</span><span class="p">,</span>
    <span class="n">assay_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">base_layer</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">new_layer_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span>
    <span class="n">base</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScpContainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply log transformation to data.</span>

<span class="sd">    Computes log_base(X + offset) for all values in the specified layer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    container : ScpContainer</span>
<span class="sd">        Input container with data to normalize</span>
<span class="sd">    assay_name : str</span>
<span class="sd">        Name of assay containing the layer to normalize</span>
<span class="sd">    base_layer : str</span>
<span class="sd">        Name of layer to transform (e.g., &quot;raw&quot;)</span>
<span class="sd">    new_layer_name : str, optional</span>
<span class="sd">        Name for the new normalized layer (default: &quot;log&quot;)</span>
<span class="sd">    base : float, optional</span>
<span class="sd">        Logarithm base (default: 2.0 for log2)</span>
<span class="sd">    offset : float, optional</span>
<span class="sd">        Additive offset to avoid log(0) (default: 1.0)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ScpContainer</span>
<span class="sd">        Container with new normalized layer added</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    LayerNotFoundError</span>
<span class="sd">        If base_layer does not exist in assay</span>
<span class="sd">    ValueError</span>
<span class="sd">        If data contains negative values</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; container = log_normalize(</span>
<span class="sd">    ...     container,</span>
<span class="sd">    ...     assay_name=&quot;proteins&quot;,</span>
<span class="sd">    ...     base_layer=&quot;raw&quot;,</span>
<span class="sd">    ...     new_layer_name=&quot;log&quot;,</span>
<span class="sd">    ...     base=2.0</span>
<span class="sd">    ... )</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Log transformation is standard for proteomics intensity data.</span>
<span class="sd">    Base 2 is commonly used (log2 fold changes).</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    sample_median_normalization : Median centering</span>
<span class="sd">    zscore_standardization : Z-score normalization</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
<hr class="docutils" />
<p><strong>Document Owner:</strong> ScpTensor Architecture Team
<strong>Review Cycle:</strong> Per release or when architecture changes
<strong>Next Review:</strong> v0.1.0-beta release</p>
<p><strong>End of ARCHITECTURE.md</strong></p>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, ScpTensor Team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">ScpTensor Architecture Specification</a><ul>
<li><a class="reference internal" href="#module-responsibility-matrix">1. Module Responsibility Matrix</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#core-layer-scptensor-core">Core Layer (scptensor.core)</a></li>
<li><a class="reference internal" href="#data-processing-modules">Data Processing Modules</a><ul>
<li><a class="reference internal" href="#normalization">normalization/</a></li>
<li><a class="reference internal" href="#impute">impute/</a></li>
<li><a class="reference internal" href="#integration">integration/</a></li>
<li><a class="reference internal" href="#qc">qc/</a></li>
<li><a class="reference internal" href="#dim-reduction">dim_reduction/</a></li>
<li><a class="reference internal" href="#cluster">cluster/</a></li>
<li><a class="reference internal" href="#viz">viz/</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#data-structure-specifications">2. Data Structure Specifications</a><ul>
<li><a class="reference internal" href="#scpcontainer">ScpContainer</a></li>
<li><a class="reference internal" href="#assay">Assay</a></li>
<li><a class="reference internal" href="#scpmatrix">ScpMatrix</a></li>
<li><a class="reference internal" href="#aggregationlink">AggregationLink</a></li>
<li><a class="reference internal" href="#provenancelog">ProvenanceLog</a></li>
</ul>
</li>
<li><a class="reference internal" href="#design-patterns">3. Design Patterns</a><ul>
<li><a class="reference internal" href="#pattern-1-immutable-layer-creation">Pattern 1: Immutable Layer Creation</a></li>
<li><a class="reference internal" href="#pattern-2-mask-based-provenance">Pattern 2: Mask-Based Provenance</a></li>
<li><a class="reference internal" href="#pattern-3-assay-aggregation-links">Pattern 3: Assay-Aggregation Links</a></li>
<li><a class="reference internal" href="#pattern-4-functional-pipeline-design">Pattern 4: Functional Pipeline Design</a></li>
</ul>
</li>
<li><a class="reference internal" href="#integration-patterns">4. Integration Patterns</a><ul>
<li><a class="reference internal" href="#pattern-a-sequential-processing">Pattern A: Sequential Processing</a></li>
<li><a class="reference internal" href="#pattern-b-branching-workflows">Pattern B: Branching Workflows</a></li>
<li><a class="reference internal" href="#pattern-c-multi-assay-analysis">Pattern C: Multi-Assay Analysis</a></li>
</ul>
</li>
<li><a class="reference internal" href="#error-handling-strategy">5. Error Handling Strategy</a><ul>
<li><a class="reference internal" href="#error-hierarchy">Error Hierarchy</a></li>
<li><a class="reference internal" href="#validation-strategy">Validation Strategy</a></li>
</ul>
</li>
<li><a class="reference internal" href="#performance-considerations">6. Performance Considerations</a><ul>
<li><a class="reference internal" href="#sparsity">Sparsity</a></li>
<li><a class="reference internal" href="#memory-management">Memory Management</a></li>
<li><a class="reference internal" href="#numba-jit">Numba JIT</a></li>
</ul>
</li>
<li><a class="reference internal" href="#extension-points">7. Extension Points</a><ul>
<li><a class="reference internal" href="#adding-new-normalization-methods">Adding New Normalization Methods</a></li>
<li><a class="reference internal" href="#adding-new-imputation-methods">Adding New Imputation Methods</a></li>
<li><a class="reference internal" href="#adding-new-integration-methods">Adding New Integration Methods</a></li>
</ul>
</li>
<li><a class="reference internal" href="#testing-strategy">8. Testing Strategy</a><ul>
<li><a class="reference internal" href="#unit-test-structure">Unit Test Structure</a></li>
<li><a class="reference internal" href="#integration-test-structure">Integration Test Structure</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deprecation-policy">9. Deprecation Policy</a><ul>
<li><a class="reference internal" href="#versioning">Versioning</a></li>
<li><a class="reference internal" href="#deprecation-process">Deprecation Process</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">Appendix</a><ul>
<li><a class="reference internal" href="#a-type-annotation-standards">A. Type Annotation Standards</a></li>
<li><a class="reference internal" href="#b-naming-conventions">B. Naming Conventions</a></li>
<li><a class="reference internal" href="#c-documentation-standards">C. Documentation Standards</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=38b66d78"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>